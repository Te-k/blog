<!DOCTYPE html>
<html lang="en">

<head>
  <title>Machine learning for malware detection | </title>

  <meta charset="UTF-8">
  <meta name="language" content="en">
  <meta name="description" content="">
  <meta name="keywords" content="malware , detection , classification , machine learning , SVM">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  
  

  <link rel="shortcut icon" type="image/png" href="/favicon.ico" />

  
  
    
 
  
  

  

  
    
    <link rel="stylesheet" href="/css/post.min.a37e0a4baf346423e1637350f2a31c69622c6d9cb0f81f78f5a90e5a04ba1795.css" integrity="sha256-o34KS680ZCPhY3NQ8qMcaWIsbZyw&#43;B949akOWgS6F5U="/>
  
    
    <link rel="stylesheet" href="/css/custom.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css" integrity="sha256-47DEQpj8HBSa&#43;/TImW&#43;5JCeuQeRkm5NMpJWZG3hSuFU="/>
  

  
   
    

<script type="application/ld+json">
  
    { 
      "@context": "http://schema.org", 
      "@type": "WebSite", 
      "url": "https:\/\/maynier.eu\/blog\/2016\/07\/16\/machine-learning-for-malware-detection\/",
      "name": "Machine learning for malware detection",
      "author": {
        "@type": "Person",
        "name": ""
      },
      "description": ""
    }
  
  </script>


</head>

<body>
  <div class="burger__container">
  <div class="burger" aria-controls="navigation" aria-label="Menu">
    <div class="burger__meat burger__meat--1"></div>
    <div class="burger__meat burger__meat--2"></div>
    <div class="burger__meat burger__meat--3"></div>
  </div>
</div>


  <nav class="nav" role="navigation">
  <ul class="nav__list">
    
    
      <li>
          
          
          
        <a  class="active" href="/">home</a>
      </li>
    
      <li>
          
          
          
        <a  class="active" href="/post/">blog</a>
      </li>
    
      <li>
          
          
          
        <a  href="/projects/">projects</a>
      </li>
    
      <li>
          
          
          
        <a  href="/resources/">resources</a>
      </li>
    
      <li>
          
          
          
        <a  href="/about/">about</a>
      </li>
    
      <li>
          
          
          
        <a  href="/contact/">contact</a>
      </li>
    
    <li></li>
    <li>
        
        EN
        
        
        
            <a href="/fr" lang="fr" class="no-translation">FR</a>
        
        
    </li>
  </ul>
</nav>


  <main>
    
    

    <div class="flex-wrapper">
      <div class="post__container">
        <div class="post">
          <header class="post__header">
            <h1 id="post__title">Machine learning for malware detection</h1>
            <time datetime="2016-07-16 12:52:42 &#43;0200 CEST" class="post__date">16 Jul 2016   &middot; 9 minutes read </time>
          </header>
          <article class="post__content">
              
<p>Plop,</p>
<p>I have been reading many articles about Machine Learning recently, and it seems to be the new hype technology so I wanted to play a bit with these algorithms to better understand the principles behind it. If you don&rsquo;t know machine learning, you should to read this <a href="http://www.r2d3.us/visual-intro-to-machine-learning-part-1/">awesome article</a> or <a href="https://redshiftzero.github.io/2015/08/29/Manipulation-and-Machine-Learning/">this one</a>. This article was largely inspired by <a href="https://blog.socialcops.com/engineering/machine-learning-python">this one which analyze the Titanic data</a>.</p>
<h2 id="machine-learning-and-classification">Machine Learning and Classification<a class="anchor" href="#machine-learning-and-classification">#</a></h2>
<p>So the idea of machine learning is to let the algorithm learn by itself the best parameters from data in order to make good predictions. There are many different applications, in our case we will consider using machine learning algorithm to classify binaries between legitimate and malicious binaries. This idea is <a href="http://ieeexplore.ieee.org/xpl/login.jsp?tp=&amp;arnumber=924286&amp;url=http%3A%2F%2Fieeexplore.ieee.org%2Fxpls%2Fabs_all.jsp%3Farnumber%3D924286">not</a> <a href="http://ieeexplore.ieee.org/xpl/login.jsp?tp=&amp;arnumber=1297538&amp;url=http%3A%2F%2Fieeexplore.ieee.org%2Fxpls%2Fabs_all.jsp%3Farnumber%3D1297538">new</a> and Adobe has even released a tool called <a href="https://github.com/adobe-security/Malware-classifier">Adobe Malware Classifier</a> at <a href="https://www.blackhat.com/html/webcast/webcast-2012-polymorphicmalware.html">Black Hat 2012</a> but it will be a nice exercice to see how to use machine learning.</p>
<p>Here is the plan that we will follow :</p>
<ul>
<li>Extract as many features as we can from binaries to have a good training data set. The features have to be integers or floats to be usable by the algorithms</li>
<li>Identify the best features for the algorithm : we should select the information that best allows to differenciate legitimate files from malware.</li>
<li>Choose a classification algorithm</li>
<li>Test the efficiency of the algorithm and identify the False Positive/False negative rate</li>
</ul>
<h2 id="feature-extraction-from-binaries">Feature Extraction from binaries<a class="anchor" href="#feature-extraction-from-binaries">#</a></h2>
<p>As I said earlier, machine learning only uses integer or float data as features for detection, but it is not a big deal as most <a href="https://manalyzer.org/report/1e27184759cc4099c0da73b152408281">PE parameters</a> are integers (field size, addresses, parameters&hellip;). So I extracted all the PE parameters I could by using pefile, and considered especially the one that are relevant for identifying malware, like the entropy of section for packer detection. As we can only have a fix list of feature (and not one per section), I extracted the Mean, Minimum and Maximum of entropy for sections and resources.</p>
<p>Here is the final list of feature extracted : <em>Name, md5, Machine, SizeOfOptionalHeader, Characteristics, MajorLinkerVersion, MinorLinkerVersion, SizeOfCode, SizeOfInitializedData, SizeOfUninitializedData, AddressOfEntryPoint, BaseOfCode, BaseOfData, ImageBase, SectionAlignment, FileAlignment, MajorOperatingSystemVersion, MinorOperatingSystemVersion, MajorImageVersion, MinorImageVersion, MajorSubsystemVersion, MinorSubsystemVersion, SizeOfImage, SizeOfHeaders, CheckSum, Subsystem, DllCharacteristics, SizeOfStackReserve, SizeOfStackCommit, SizeOfHeapReserve, SizeOfHeapCommit, LoaderFlags, NumberOfRvaAndSizes, SectionsNb, SectionsMeanEntropy, SectionsMinEntropy, SectionsMaxEntropy, SectionsMeanRawsize, SectionsMinRawsize, SectionMaxRawsize, SectionsMeanVirtualsize, SectionsMinVirtualsize, SectionMaxVirtualsize, ImportsNbDLL, ImportsNb, ImportsNbOrdinal, ExportNb, ResourcesNb, ResourcesMeanEntropy, ResourcesMinEntropy, ResourcesMaxEntropy, ResourcesMeanSize, ResourcesMinSize, ResourcesMaxSize, LoadConfigurationSize, VersionInformationSize.</em></p>
<p>Many other feature could have been considered, for instance the number of suspicious function imported, or the number of section with a abnormal name, but it will be for another time (I ended the script a bit late in the night and forgot to implement those ¯\<em>(ツ)</em>/¯ ).</p>
<p>Regarding the dataset, we need to have an important number of both legitimate and malicious file:</p>
<ul>
<li>For legitimate file, I gathered all the Windows binaries (exe + dll) from Windows 2008, Windows XP and Windows 7 32 and 64 bits, so exactly 41323 binaries. It is not a perfect dataset as there is only Microsoft binaries and not binaries from application which could have different properties, but I did not find any easy way to gather easily a lot of legitimate binaries, so it will be enough for playing</li>
<li>Regarding malware, I used a part of <a href="https://virusshare.com/">Virus Share</a> collection by downloading one archive (the 134th) and kept only PE files (96724 different files).</li>
</ul>
<p>I used <a href="https://github.com/erocarrera/pefile">pefile</a> to extract all these features from the binaries and store them in a csv file (ugly code is <a href="https://github.com/Te-k/malware-classification/blob/master/generatedata.py">here</a>, <a href="https://github.com/Te-k/malware-classification/blob/master/data.csv">data</a> are here).</p>
<p>And here we are with a large CSV file (138048 lines) ready for playing!</p>
<h2 id="feature-selection">Feature Selection<a class="anchor" href="#feature-selection">#</a></h2>
<p>The idea of feature selection is to reduce the 54 features extracted to a smaller set of feature which are the most relevant for differentiating legitimate binaries from malware.</p>
<p>To play with the data, we will use <a href="http://pandas.pydata.org/">Pandas</a> and then <a href="http://scikit-learn.org/stable/index.html">Scikit</a> which largely uses the <a href="http://www.numpy.org/">numpy</a> library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;data.csv&#39;</span>, sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;|&#39;</span>)
</span></span><span style="display:flex;"><span>legit_binaries <span style="color:#f92672">=</span> data[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">41323</span>]<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#39;legitimate&#39;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>malicious_binaries <span style="color:#f92672">=</span> data[<span style="color:#ae81ff">41323</span>::]<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#39;legitimate&#39;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span></code></pre></div><p>So a first way of doing it manually could be to check the different values and see if there is a difference between the two groups. For instance, we can take the parameter FileAlignment (which defines the alignment of sections and is by default 0x200 bytes) and check the values :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#ae81ff">8</span>]: legit_binaries[<span style="color:#e6db74">&#39;FileAlignment&#39;</span>]<span style="color:#f92672">.</span>value_counts()
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">8</span>]:
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">512</span>      <span style="color:#ae81ff">36843</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4096</span>      <span style="color:#ae81ff">4313</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">128</span>         <span style="color:#ae81ff">89</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">32</span>          <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">65536</span>       <span style="color:#ae81ff">36</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">16</span>           <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>Name: FileAlignment, dtype: int64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">9</span>]: malicious_binaries[<span style="color:#e6db74">&#39;FileAlignment&#39;</span>]<span style="color:#f92672">.</span>value_counts()
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">9</span>]:
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">512</span>     <span style="color:#ae81ff">94612</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4096</span>     <span style="color:#ae81ff">2074</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">128</span>        <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1024</span>       <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span>          <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">32</span>          <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">16</span>          <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2048</span>        <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Name: FileAlignment, dtype: int64
</span></span></code></pre></div><p>So if we remove the 20 malware having weird values here, there is not much difference on this value between the two groups, this parameter would not make a good feature for us.</p>
<p>On the other side, some values are clearly interesting like the max entropy of the sections which can be represented with an histogram:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#ae81ff">12</span>]: plt<span style="color:#f92672">.</span>hist([legit_binaries[<span style="color:#e6db74">&#39;SectionsMaxEntropy&#39;</span>], malicious_binaries[<span style="color:#e6db74">&#39;SectionsMaxEntropy&#39;</span>]], range<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">8</span>], normed<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, color<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;green&#34;</span>, <span style="color:#e6db74">&#34;red&#34;</span>],label<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;legitimate&#34;</span>, <span style="color:#e6db74">&#34;malicious&#34;</span>])
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">12</span>]:
</span></span><span style="display:flex;"><span>([array([ <span style="color:#ae81ff">0.</span>        ,  <span style="color:#ae81ff">0.00120095</span>,  <span style="color:#ae81ff">0.00129333</span>,  <span style="color:#ae81ff">0.00914567</span>,  <span style="color:#ae81ff">0.08896238</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0.04665213</span>,  <span style="color:#ae81ff">0.12609933</span>,  <span style="color:#ae81ff">0.55631513</span>,  <span style="color:#ae81ff">0.37580371</span>,  <span style="color:#ae81ff">0.04452738</span>]),
</span></span><span style="display:flex;"><span>  array([  <span style="color:#ae81ff">9.04607814e-05</span>,   <span style="color:#ae81ff">0.00000000e+00</span>,   <span style="color:#ae81ff">1.29229688e-05</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">1.55075625e-04</span>,   <span style="color:#ae81ff">5.16918751e-04</span>,   <span style="color:#ae81ff">1.51198735e-03</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">6.04794938e-03</span>,   <span style="color:#ae81ff">8.64675840e-02</span>,   <span style="color:#ae81ff">3.81266348e-01</span>,
</span></span><span style="display:flex;"><span>                                            <span style="color:#ae81ff">7.73930754e-01</span>])],
</span></span><span style="display:flex;"><span>  array([ <span style="color:#ae81ff">0.</span> ,  <span style="color:#ae81ff">0.8</span>,  <span style="color:#ae81ff">1.6</span>,  <span style="color:#ae81ff">2.4</span>,  <span style="color:#ae81ff">3.2</span>,  <span style="color:#ae81ff">4.</span> ,  <span style="color:#ae81ff">4.8</span>,  <span style="color:#ae81ff">5.6</span>,  <span style="color:#ae81ff">6.4</span>,  <span style="color:#ae81ff">7.2</span>,  <span style="color:#ae81ff">8.</span> ]),
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;</span>a list of <span style="color:#ae81ff">2</span> Lists of Patches objects<span style="color:#f92672">&gt;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">13</span>]: plt<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">13</span>]: <span style="color:#f92672">&lt;</span>matplotlib<span style="color:#f92672">.</span>legend<span style="color:#f92672">.</span>Legend at <span style="color:#ae81ff">0x7f15da65ee10</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">14</span>]: plt<span style="color:#f92672">.</span>show()
</span></span></code></pre></div><figure><img src="/media/sectionsmaxentropy.png">
</figure>

<p>But there is a more efficient way of selecting features : some algorithms have been developed to identify the most interesting features and reduce the dimensionality of the data set (see <a href="http://scikit-learn.org/stable/modules/feature_selection.html">the Scikit page for Feature Selection</a>).</p>
<p>In our case, we will use the <a href="http://scikit-learn.org/stable/modules/feature_selection.html#tree-based-feature-selection">Tree-based feature selection</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#ae81ff">15</span>]: X <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#39;Name&#39;</span>, <span style="color:#e6db74">&#39;md5&#39;</span>, <span style="color:#e6db74">&#39;legitimate&#39;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">16</span>]: y <span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#39;legitimate&#39;</span>]<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">17</span>]: fsel <span style="color:#f92672">=</span> ske<span style="color:#f92672">.</span>ExtraTreesClassifier()<span style="color:#f92672">.</span>fit(X, y)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">20</span>]: model <span style="color:#f92672">=</span> SelectFromModel(fsel, prefit<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">21</span>]: X_new <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>transform(X)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">22</span>]: X<span style="color:#f92672">.</span>shape
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">22</span>]: (<span style="color:#ae81ff">110258</span>, <span style="color:#ae81ff">54</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">23</span>]: X_new<span style="color:#f92672">.</span>shape
</span></span><span style="display:flex;"><span>Out[<span style="color:#ae81ff">23</span>]: (<span style="color:#ae81ff">110258</span>, <span style="color:#ae81ff">11</span>)
</span></span></code></pre></div><p>So in this case, the algorithm selected 11 important features among the 54, and we can notice that indeed the SectionsMaxEntropy is selected but other features (like the Machine value) are surprisingly also good parameters for this classification :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>In [<span style="color:#ae81ff">1</span>]: nb_features <span style="color:#f92672">=</span> X_new<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">2</span>]: indices <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argsort(fsel<span style="color:#f92672">.</span>feature_importances_)[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][:nb_features]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [<span style="color:#ae81ff">3</span>]: <span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> range(nb_features):
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>:         print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">. feature </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">%f</span><span style="color:#e6db74">)&#34;</span> <span style="color:#f92672">%</span> (f <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, data<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">2</span><span style="color:#f92672">+</span>indices[f]], fsel<span style="color:#f92672">.</span>feature_importances_[indices[f]]))
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">...</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1.</span> feature Characteristics (<span style="color:#ae81ff">0.187685</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">2.</span> feature Machine (<span style="color:#ae81ff">0.173019</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">3.</span> feature ImageBase (<span style="color:#ae81ff">0.099215</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">4.</span> feature Subsystem (<span style="color:#ae81ff">0.091090</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">5.</span> feature MajorSubsystemVersion (<span style="color:#ae81ff">0.077067</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">6.</span> feature SectionsMaxEntropy (<span style="color:#ae81ff">0.046552</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">7.</span> feature SizeOfOptionalHeader (<span style="color:#ae81ff">0.040004</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">8.</span> feature ResourcesMaxEntropy (<span style="color:#ae81ff">0.035633</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">9.</span> feature VersionInformationSize (<span style="color:#ae81ff">0.027091</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">10.</span> feature SectionsNb (<span style="color:#ae81ff">0.020562</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">11.</span> feature DllCharacteristics (<span style="color:#ae81ff">0.018640</span>)
</span></span></code></pre></div><h2 id="selection-of-the-classification-algorithm">Selection of the Classification Algorithm<a class="anchor" href="#selection-of-the-classification-algorithm">#</a></h2>
<p>The best classification algorithm depends on many parameters and some of them (like SVM) have a lot of different parameters and can be difficult to correctly configure. So I used a simple option: I tested some of them with default parameters and selected the best one (I removed SVM because it does not handle well dataset with many features):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>algorithms <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;DecisionTree&#34;</span>: tree<span style="color:#f92672">.</span>DecisionTreeClassifier(max_depth<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;RandomForest&#34;</span>: ske<span style="color:#f92672">.</span>RandomForestClassifier(n_estimators<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;GradientBoosting&#34;</span>: ske<span style="color:#f92672">.</span>GradientBoostingClassifier(n_estimators<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;AdaBoost&#34;</span>: ske<span style="color:#f92672">.</span>AdaBoostClassifier(n_estimators<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;GNB&#34;</span>: GaussianNB()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>results <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Now testing algorithms&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> algo <span style="color:#f92672">in</span> algorithms:
</span></span><span style="display:flex;"><span>    clf <span style="color:#f92672">=</span> algorithms[algo]
</span></span><span style="display:flex;"><span>    clf<span style="color:#f92672">.</span>fit(X_train, y_train)
</span></span><span style="display:flex;"><span>    score <span style="color:#f92672">=</span> clf<span style="color:#f92672">.</span>score(X_test, y_test)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> : </span><span style="color:#e6db74">%f</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%%</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (algo, score<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span>))
</span></span><span style="display:flex;"><span>    results[algo] <span style="color:#f92672">=</span> score
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>winner <span style="color:#f92672">=</span> max(results, key<span style="color:#f92672">=</span>results<span style="color:#f92672">.</span>get)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Winner algorithm is </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> with a </span><span style="color:#e6db74">%f</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%%</span><span style="color:#e6db74"> success&#39;</span> <span style="color:#f92672">%</span> (winner, results[winner]<span style="color:#f92672">*</span><span style="color:#ae81ff">100</span>))
</span></span></code></pre></div><p>Let&rsquo;s run it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>Now testing algorithms
</span></span><span style="display:flex;"><span>GNB : <span style="color:#ae81ff">69.478450</span> <span style="color:#f92672">%</span>
</span></span><span style="display:flex;"><span>DecisionTree : <span style="color:#ae81ff">98.960522</span> <span style="color:#f92672">%</span>
</span></span><span style="display:flex;"><span>RandomForest : <span style="color:#ae81ff">99.351684</span> <span style="color:#f92672">%</span>
</span></span><span style="display:flex;"><span>AdaBoost : <span style="color:#ae81ff">98.558493</span> <span style="color:#f92672">%</span>
</span></span><span style="display:flex;"><span>GradientBoosting : <span style="color:#ae81ff">98.761318</span> <span style="color:#f92672">%</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Winner algorithm <span style="color:#f92672">is</span> RandomForest <span style="color:#66d9ef">with</span> a <span style="color:#ae81ff">99.351684</span> <span style="color:#f92672">%</span> success
</span></span></code></pre></div><p>If we recompute the false positive/false negative rate on the test data, we obtain :</p>
<ul>
<li>False positive : 0.568241 %</li>
<li>False negative : 0.830565 %</li>
</ul>
<p>So it&rsquo;s a 99.35% success, so more than the <a href="https://www.blackhat.com/docs/webcast/TowardsClassificationofPolymorphicMalware-Final.pdf">Adobe</a> work (98.21%) but still with the RandomForest algorithm.</p>
<p>The whole code for feature selection and algorithm test is available <a href="https://github.com/Te-k/malware-classification/blob/master/learning.py">here</a></p>
<h2 id="reuse-the-algorithm">Reuse the algorithm<a class="anchor" href="#reuse-the-algorithm">#</a></h2>
<p>So now we want to reuse this algorithms for detection, we can just save the object and the feature list :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>joblib<span style="color:#f92672">.</span>dump(algorithms[winner], <span style="color:#e6db74">&#39;classifier/classifier.pkl&#39;</span>)
</span></span><span style="display:flex;"><span>open(<span style="color:#e6db74">&#39;classifier/features.pkl&#39;</span>, <span style="color:#e6db74">&#39;w&#39;</span>)<span style="color:#f92672">.</span>write(pickle<span style="color:#f92672">.</span>dumps(features))
</span></span></code></pre></div><p>I have then implemented a <a href="https://github.com/Te-k/malware-classification/blob/master/checkpe.py">simple tool</a> which load the feature list and the classifier, extract the PE feature and predict if a binary is malicious or not:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> python2 checkpe<span style="color:#f92672">.</span>py <span style="color:#f92672">~/</span>virusshare<span style="color:#f92672">/</span>VirusShare_000b296200f7b8fffbc584f3eac864b2
</span></span><span style="display:flex;"><span>The file VirusShare_000b296200f7b8fffbc584f3eac864b2 <span style="color:#f92672">is</span> malicious
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> python2 checkpe<span style="color:#f92672">.</span>py <span style="color:#f92672">~/</span>legitimate<span style="color:#f92672">/</span>explorer<span style="color:#f92672">.</span>exe
</span></span><span style="display:flex;"><span>The file explorer<span style="color:#f92672">.</span>exe <span style="color:#f92672">is</span> legitimate
</span></span></code></pre></div><p>As I like the new <a href="https://manalyzer.org/">Manalyzer</a> platform, I have also developed <a href="https://github.com/Te-k/malware-classification/blob/master/checkmanalyzer.py">a script</a> which download the PE properties and predict if the binary is legitimate of not:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;</span>python2 checkmanalyzer<span style="color:#f92672">.</span>py https:<span style="color:#f92672">//</span>manalyzer<span style="color:#f92672">.</span>org<span style="color:#f92672">/</span>report<span style="color:#f92672">/</span>a9ea61c5ae7eab02c63955336a7c7efe
</span></span><span style="display:flex;"><span>The file a9ea61c5ae7eab02c63955336a7c7efe <span style="color:#f92672">is</span> legitimate
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> python2 checkmanalyzer<span style="color:#f92672">.</span>py https:<span style="color:#f92672">//</span>manalyzer<span style="color:#f92672">.</span>org<span style="color:#f92672">/</span>report<span style="color:#f92672">/</span><span style="color:#ae81ff">9</span>c5c27494c28ed0b14853b346b113145
</span></span><span style="display:flex;"><span>The file <span style="color:#ae81ff">9</span>c5c27494c28ed0b14853b346b113145 <span style="color:#f92672">is</span> malicious
</span></span></code></pre></div><h2 id="why-its-not-enough">Why it&rsquo;s not enough?<a class="anchor" href="#why-its-not-enough">#</a></h2>
<p>First, a bit of vocabulary for measuring IDS accuracy (taken from <a href="https://en.wikipedia.org/wiki/Sensitivity_and_specificity">Wikipedia</a>):</p>
<ul>
<li><strong>Sensitivity</strong> : the proportion of positives identified as such (or true positive rate)</li>
<li><strong>Specificity</strong> : the proportion of negatives correctly identified as such (or true negative)</li>
<li><strong>False Positive Rate</strong> (FPR) : the proportion of events badly identified as positive over the total number of negatives</li>
<li><strong>False Negative Rate</strong> (FNR) : the proportion of events badly identified as negative over the total number of positives</li>
</ul>
<p>So why 99.35% is not enough?</p>
<p>Because you can&rsquo;t just consider the sensitivity/specificity of the algorithm, you have to consider the malicious over legitimate traffic ratio to understand how many alerts will be generated by the IDS. And this ratio is extremely low.</p>
<p>Let&rsquo;s consider the you have 1 malicious event every 10 000 event (it&rsquo;s a really high ratio) and 1 000 000 events per day, you will have :</p>
<ul>
<li>100 malicious events, 99 identified by the tool and 1 false negative (0.83% FNR but let&rsquo;s consider 1% here)</li>
<li>999 900 legitimate events, around 6499 identified as malicious (0.65% FPR)</li>
</ul>
<p>So in the end, <strong>the analyst would received 6598 alerts per day with only 99 true positive in it (1.5%)</strong>. Your IDS is useless here. (Out of curiosity, the same problem applies when <a href="http://www.jaddo.fr/2016/06/19/et-mes-fesses-elles-sont-roses-mes-fesses/">detecting cancer at large scale</a> (in French))</p>
<p>If we take our example, a standard Windows 7 install has around 15000 binary files (it seems to be very different depending on the version, but let&rsquo;s say 15000), which means that in average 97 files would be detected incorrectly as malicious. And that&rsquo;s a bad antivirus.</p>
<h2 id="conclusion">Conclusion<a class="anchor" href="#conclusion">#</a></h2>
<p>So it was a fun example of machine learning utilization. I like how Pandas and Scikit make machine learning easy to use in python (and Scikit is really well explained and documented!). I was really surprised to have such good results without any effort for configuring the algorithm specifically for this context, and it shows that the Adobe tool is not as good as I thought.</p>
<p>Still, it is interesting to remind the IDS problem and show it concretely (just after self-congratulation for such a good sensitivity :).</p>
<p>If you have any question, comment or idea to continue playing with this dataset, let me know on <a href="https://twitter.com/tenacioustek">Twitter</a>.</p>
<p>Here are some nice references on this topic:</p>
<ul>
<li><a href="http://pandas.pydata.org/pandas-docs/stable/10min.html">Learning Pandas in 10 minutes</a></li>
<li><a href="https://blog.socialcops.com/engineering/machine-learning-python">Would You Survive the Titanic? A Guide to Machine Learning in Python</a></li>
<li><a href="http://scikit-learn.org/stable/index.html">Scikit Learn</a></li>
</ul>
<p>Adéu!</p>
<p><em>Edit 21/07/16: improved the dataset with more legitimate binaries. Updated the results</em>
<em>Edit 02/08/16: explained why it&rsquo;s not enough</em></p>
<p><em>This article was written mainly while listening Glenn Gould <a href="https://www.youtube.com/watch?v=Ah392lnFHxM">Goldberg Variations (1955)</a></em></p>


              
          </article>
          

<ul class="tags__list">
    
    <li class="tag__item">
        <a class="tag__link" href="https://maynier.eu/tags/malware/">malware</a>
    </li>
    <li class="tag__item">
        <a class="tag__link" href="https://maynier.eu/tags/machine-learning/">machine-learning</a>
    </li></ul>

 <div class="pagination">
  
    <a class="pagination__item" href="https://maynier.eu/blog/2016/05/14/comparison-of-php-scanners/">
        <span class="pagination__label">Previous Post</span>
        <span class="pagination__title">Comparison of php scanners</span>
    </a>
  

  
    <a class="pagination__item" href="https://maynier.eu/blog/2016/08/01/openssh-backdoor-used-on-compromised-linux-servers/">
      <span class="pagination__label">Next Post</span>
      <span class="pagination__title" >Openssh backdoor used on compromised Linux servers</a>
    </a>
  
</div>

          
          <footer class="post__footer">
            


<div class="social-icons">
  
    
    
  
    
    
      <a class="social-icons__icon" title="Mastodon"
         style="background-image: url(/images/social/mastodon.svg)"
         href="https://todon.eu/@tek"
         target="_blank" rel="noopener">
      </a>
    
  
    
    
      <a class="social-icons__icon" title="BlueSky"
         style="background-image: url(/images/social/bluesky.svg)"
         href="https://bsky.app/profile/tek.randhome.io"
         target="_blank" rel="noopener">
      </a>
    
  
    
    
      <a class="social-icons__icon" title="GitHub"
         style="background-image: url(/images/social/github.svg)"
         href="https://github.com/Te-k"
         target="_blank" rel="noopener">
      </a>
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
  
    
    
      <a class="social-icons__icon" title="Rss"
         style="background-image: url(/images/social/rss.svg)"
         href="/index.xml"
         target="_blank" rel="noopener">
      </a>
    
  
    
    
      <a class="social-icons__icon" title="Email"
         style="background-image: url(/images/social/email.svg)"
         href="mailto:etienne@maynier.eu"
         target="_blank" rel="noopener">
      </a>
    
  
</div>

            <p>© 2025</p>
          </footer>
          </div>
      </div>
      
    </div>


  </main>

   

  
  <script src="/js/index.min.301a8b0870381bf76b3b5182e8966d363a0474281183439beb024d8b8228fc66.js" integrity="sha256-MBqLCHA4G/drO1GC6JZtNjoEdCgRg0Ob6wJNi4Io/GY=" crossorigin="anonymous"></script>
  
  


</body>

</html>
