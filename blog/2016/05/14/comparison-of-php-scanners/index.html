<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta property="og:title" content=" Comparison of php scanners &middot;  Tek&#39;s blog" />
<meta property="og:site_name" content="Tek&#39;s blog" />
<meta property="og:url" content="https://www.randhome.io/blog/2016/05/14/comparison-of-php-scanners/" />


    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content="2016-05-14T17:44:19&#43;02:00" />
    

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@http://twitter.com/tenacioustek" />
    <meta name="twitter:creator" content="@http://twitter.com/tenacioustek" />
    <meta name="twitter:title" content="Comparison of php scanners" />
    <meta name="twitter:description" content="" />
    <meta name="twitter:url" content="https://www.randhome.io/blog/2016/05/14/comparison-of-php-scanners/" />


<title> Comparison of php scanners &middot;  Tek&#39;s blog</title>


    <meta name="description" content="" />


<meta name="p:domain_verify" content="fc173d84e3a4de948ed4bda2908afd3e"/>
<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />





<link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,700italic,300,700' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Bree+Serif' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://www.randhome.io/css/pure-min.css">


    <link rel="stylesheet" href="https://www.randhome.io/css/grids-responsive-min.css">

<link rel="stylesheet" href="https://www.randhome.io/css/crisp.css">
<link rel="stylesheet" href="https://www.randhome.io/css/rrssb.css">
<link rel="stylesheet" href="https://www.randhome.io/css/highlight/sunburst.css">







<link rel="canonical" href="https://www.randhome.io/blog/2016/05/14/comparison-of-php-scanners/" />


    


    </head>
    <div id="layout" class="pure-g">
        <div class="sidebar pure-u-1 pure-u-md-1-6">
            <div class="header">
    <div class="title">
        <h1><a href="https://www.randhome.io/">Tek&#39;s blog</a></h1>
        <p class="lead">Random Security Stuff</p>
        
    </div>
    <div class="logo">
        
        
            
                <a id="logo" href="https://www.randhome.io/"><img src="/avatar2.png" alt="Tek&#39;s blog" /></a>
            
        
    </div>

    <ul class="sidebar-menu">
        
            <li class="sidebar-menu-item"><a href="https://www.randhome.io/references/">#references</a></li>
        
            <li class="sidebar-menu-item"><a href="https://www.randhome.io/about/">#whoami</a></li>
        
    </ul>

    <div id="follow-icons">
        
        <a href="http://twitter.com/tenacioustek" target="_blank" rel="me"><i class="fa fa-twitter-square fa-3x"></i></a>
        
        <a href="http://github.com/Te-k" target="_blank" rel="me"><i class="fa fa-github-square fa-3x"></i></a>
        
        
        
        <a href="https://keybase.io/tekkk" target="_blank"><i class="fa fa-key fa-3x"></i></a>
        <a href="https://www.randhome.io/index.xml" type="application/rss+xml"><i class="fa fa-rss-square fa-3x"></i></a>
    </div>

    
        <div class="cc">
            
            
            
            
            
                <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a>
            
        </div>
    
</div>

        </div>
        <div class="content pure-u-1 pure-u-md-5-6">
            <div class="article singlepage" id="" class="post">
                <div class="post-stamp">
                    <h1 class="post-title">Comparison of php scanners</h1>
                    <span class="post-date">May 14, 2016 &middot; 4 minute read</span>
                    
                        <span class="taglist">
                            <a class="label" href="https://www.randhome.io/categories/malware">malware</a> <a class="label" href="https://www.randhome.io/categories/tools">tools</a> <a class="label" href="https://www.randhome.io/categories/php">php</a> 
                        </span>
                    

                    <span class="taglist">
                    
                    </span>
                </div>
                

<p>Hi there!</p>

<p>I have recently looked different compromised websites on github, mostly using outdated Wordpress/Joomla/Drupal versions. In these cases, I often have to go through many different files to find the malicious one, whether added on the website or added to legitimate files. Here is a short summary of the different tools to detect them.</p>

<h2 id="clamav">ClamAV</h2>

<p><center><img src="/media/clamav.png" alt="clamav logo" /></center></p>

<p><a href="https://www.clamav.net/">ClamAV</a> is an open-source antivirus developed for different platform, but also one of the seldom antivirus used on Linux. It has a complex signature format with many open signature provided by the community (more than 3 700 000 according to wikipedia). And the good news, is that <a href="http://blog.clamav.net/2015/06/clamav-099b-meets-yara.html">it supports Yara</a> since last year!</p>

<p>It is possible to convert some of the clamav signature to Yara thanks to <a href="https://github.com/Te-k/analyst-scripts/blob/master/tools/clamav_to_yara.py">the nice script</a> published in the Malware Analyst Cookbook by Michael Ligh, Steven Adair, Blake Hartstein, Matthew Richard :</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span>sigtool -u main.cvd
python clamav_to_yara.py -f main.ndb -o main.yara
</pre></div>

<p>Clamav has several signatures related to php backdoors, like this nice one in daily.ldb (logical signatures in .ldb files are not converted by the previous script):</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span>Php.Malware.Mailbot<span style="color: #666666">-</span><span style="color: #40a070">45</span>;Engine:<span style="color: #40a070">51</span><span style="color: #666666">-</span><span style="color: #40a070">255</span>,Target:<span style="color: #40a070">7</span>;<span style="color: #40a070">0</span><span style="color: #666666">&amp;</span><span style="color: #40a070">1</span>;<span style="color: #40a070">6563686</span>F207068705F6F732E<span style="border: 1px solid #FF0000">{</span><span style="color: #666666">-</span><span style="color: #40a070">35</span><span style="border: 1px solid #FF0000">}</span><span style="color: #40a070">275</span>D2830393837363534333231292E;<span style="color: #40a070">6563686</span>F207068705F6F732E<span style="border: 1px solid #FF0000">{</span><span style="color: #666666">-</span><span style="color: #40a070">35</span><span style="border: 1px solid #FF0000">}</span><span style="color: #40a070">275</span>D2832323232323232323232292E
</pre></div>

<p>Shortly explained, this signature is a logical clamav signature with a format NAME;INFOS;CONDITION;PATTERN1;PATTERN2&hellip;</p>

<ul>
<li>The infos contains information on the clamav engine needed to read this signature and the type of target file (7 is ASCII file)</li>
<li>The condition here is <em>0&amp;1</em> so both patterns should be present for the signature to match.</li>
<li>Patterns are in hexadecimal format and {-XX} means that at most XX characters are not considered in the pattern. Apparently signatures on ascii files are case insensitive.</li>
</ul>

<p>So we can convert this signature to the following yara signature</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span>rule php_malware_mailbot_45 {
    strings:
        <span style="color: #bb60d5">$a</span> <span style="color: #666666">=</span> <span style="color: #235388">/echo php_os\..{,35}&#39;\]\(0987654321\)\./</span> nocase
        <span style="color: #bb60d5">$b</span> <span style="color: #666666">=</span> <span style="color: #235388">/echo php_os\..{,35}&#39;\]\(2222222222\)\./</span> nocase

    condition:
        all of them
}
</pre></div>

<h2 id="linux-malware-detect">linux-malware-detect</h2>

<p><a href="https://github.com/rfxn/linux-malware-detect">Linux Malware Detect</a> uses signatures extracted from Clamav and other tools to detect malware, mainly based on md5 hashes of malicious files (and thus not very reliable). The tool was not updated since 2013 apparently, and according to the documentation it contained 8,908 MD5 / 1,914 signatures.</p>

<h2 id="php-malware-finder">php-malware-finder</h2>

<p><a href="https://github.com/nbs-system/php-malware-finder">php-malware-finder</a> is a tool developed by <a href="https://www.nbs-system.com/">NBS System</a> based on <a href="https://github.com/nbs-system/php-malware-finder/blob/master/php-malware-finder/phpmalwarefinder">a simple shell script</a> which rely mainly on Yara signatures to detect malicious files.</p>

<p>This tool has some <a href="https://github.com/nbs-system/php-malware-finder/blob/master/php-malware-finder/php.yar">nice rules</a> for instance for detecting obfuscated php:</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span>rule ObfuscatedPhp
{
    strings:
        <span style="color: #bb60d5">$eval</span> <span style="color: #666666">=</span> <span style="color: #235388">/(&lt;\?php|[;{}])[ \t]*@?(eval|preg_replace|system|assert|passthru|(pcntl_)?exec|win_shell_execute|call_user_func(_array)?)\s*\(/</span> nocase  <span style="color: #235388">//</span> ;<span style="color: #007020">eval</span>( <span style="color: #666666">&lt;-</span> this is dodgy
        <span style="color: #bb60d5">$b374k</span> <span style="color: #666666">=</span> <span style="color: #4070a0">&quot;&#39;ev&#39;.&#39;al&#39;&quot;</span>
        <span style="color: #bb60d5">$align</span> <span style="color: #666666">=</span> <span style="color: #235388">/(\$\w+=[^;]*)*;\$\w+=@?\$\w+\(/</span>  <span style="color: #235388">//</span>b374k
        <span style="color: #bb60d5">$weevely3</span> <span style="color: #666666">=</span> <span style="color: #235388">/\$\w=\$[a-zA-Z]\(&#39;&#39;,\$\w\);\$\w\(\);/</span>  <span style="color: #235388">//</span> weevely3 launcher
        <span style="color: #bb60d5">$c99_launcher</span> <span style="color: #666666">=</span> <span style="color: #235388">/;\$\w+\(\$\w+(,\s?\$\w+)+\);/</span>  <span style="color: #235388">//</span> http:<span style="color: #235388">//</span>bartblaze<span style="color: #666666">.</span>blogspot<span style="color: #666666">.</span>fr<span style="color: #235388">/2015/</span><span style="color: #40a070">03</span><span style="color: #666666">/</span>c99shell<span style="color: #666666">-</span><span style="color: #007020; font-weight: bold">not</span><span style="color: #666666">-</span>dead<span style="color: #666666">.</span>html
        <span style="color: #bb60d5">$variable_variable</span> <span style="color: #666666">=</span> <span style="color: #235388">/\${\$[0-9a-zA-z]+}/</span>
        <span style="color: #bb60d5">$too_many_chr</span> <span style="color: #666666">=</span> <span style="color: #235388">/(chr\([\d]+\)\.){5}/</span>  <span style="color: #235388">//</span> concatenation of more than two <span style="color: #4070a0">`chr()`</span>
        <span style="color: #bb60d5">$concat</span> <span style="color: #666666">=</span> <span style="color: #235388">/(\$[^\n\r]+\.){5}/</span>  <span style="color: #235388">//</span> concatenation of more than <span style="color: #40a070">5</span> words
        <span style="color: #bb60d5">$var_as_func</span> <span style="color: #666666">=</span> <span style="color: #235388">/\$_(GET|POST|COOKIE|REQUEST)\s*\[[^\]]+\]\s*\(/</span>
        <span style="color: #bb60d5">$gif</span> <span style="color: #666666">=</span> <span style="color: #235388">/^GIF89/</span>
    condition:
        any of them <span style="color: #007020; font-weight: bold">and</span> <span style="color: #007020; font-weight: bold">not</span> IsWhitelisted
}
</pre></div>

<p>The problem is that there is only generic methods (nothing designed for specific sample) so it misses a lot of samples (many basic webshells for instance), and some methods (like Dodgy php) are generating a lot of false positive.</p>

<h2 id="php-malware-scanner">php-malware-scanner</h2>

<p><a href="https://github.com/planet-work/php-malware-scanner">php-malware-scanner</a> has been developed by the french company <a href="https://www.planet-work.com/">planet-work</a> likely to clean their own hosted websites and the result is pretty good.</p>

<p>Their idea was too make a score with different parameters often identified in malicious php files, here is a short list as example :</p>

<ul>
<li>MANY_GLOBALS : Contains $GLOBALS many times (+20)</li>
<li>MD5_VAR : contains a MD5 variable (+2)</li>
<li>VERY_LONG_LINE_EARLY : the file has a first ver long line (+10)</li>
<li>HAS_BASE64DECODE : has a function base64_decode() or str_rot13()</li>
</ul>

<p>This approach is nice, but the problem is that the code is real mess with a long list of if/else. Have a look:</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020; font-weight: bold">if</span> re<span style="color: #666666">.</span>compile(<span style="color: #4070a0">&#39;.*=\s*&quot;http://[a-z0-9].*&quot;;&#39;</span>)<span style="color: #666666">.</span>match(l) <span style="color: #007020; font-weight: bold">or</span> re<span style="color: #666666">.</span>compile(<span style="color: #4070a0">&quot;.*=\s*&#39;http:.*&#39;;&quot;</span>)<span style="color: #666666">.</span>match(l) :
    <span style="color: #007020; font-weight: bold">if</span> <span style="color: #007020; font-weight: bold">not</span> <span style="color: #4070a0">&#39;simpletest.org&#39;</span> <span style="color: #007020; font-weight: bold">in</span> l <span style="color: #007020; font-weight: bold">and</span> <span style="color: #007020; font-weight: bold">not</span> <span style="color: #4070a0">&#39;facebook.com&#39;</span> <span style="color: #007020; font-weight: bold">in</span> l:
	has_var_http <span style="color: #666666">=</span> <span style="color: #007020">True</span>
<span style="color: #007020; font-weight: bold">if</span> has_var_http <span style="color: #007020; font-weight: bold">and</span> (<span style="color: #4070a0">&#39;curl_exec&#39;</span> <span style="color: #007020; font-weight: bold">in</span> l <span style="color: #007020; font-weight: bold">or</span> <span style="color: #4070a0">&#39;xxxxxxxxxx&#39;</span> <span style="color: #007020; font-weight: bold">in</span> l) <span style="color: #007020; font-weight: bold">and</span> line_num <span style="color: #666666">&lt;</span> <span style="color: #40a070">20</span>:
    score<span style="color: #666666">.</span>append((<span style="color: #4070a0">&#39;CURL_HTTP&#39;</span> ,<span style="color: #4070a0">&#39;&#39;</span>))
<span style="color: #007020; font-weight: bold">if</span> line_num <span style="color: #666666">&lt;</span> line_early <span style="color: #007020; font-weight: bold">and</span> <span style="color: #4070a0">&#39;call_user_func&#39;</span> <span style="color: #007020; font-weight: bold">in</span> l:
    score<span style="color: #666666">.</span>append((<span style="color: #4070a0">&#39;HAS_CALL_FUNC_EARLY&#39;</span>,<span style="color: #4070a0">&#39;line </span><span style="color: #70a0d0; font-style: italic">%i</span><span style="color: #4070a0">&#39;</span> <span style="color: #666666">%</span> line_num))
<span style="color: #007020; font-weight: bold">if</span> <span style="color: #4070a0">&#39;agent&#39;</span> <span style="color: #007020; font-weight: bold">in</span> l<span style="color: #666666">.</span>lower() <span style="color: #007020; font-weight: bold">and</span> <span style="color: #4070a0">&#39;google&#39;</span> <span style="color: #007020; font-weight: bold">in</span> l<span style="color: #666666">.</span>lower():
    score<span style="color: #666666">.</span>append((<span style="color: #4070a0">&#39;UA_GOOGLE&#39;</span>,<span style="color: #4070a0">&#39;&#39;</span>))
</pre></div>

<p>And even though they have added few signature directly in the code (hurrr), there are really few of them and the tool is often missing easy to detect samples. The following basic shell added to a legitimate php file would go undetected for instance:</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020">&lt;?php</span> <span style="color: #666666">@</span><span style="color: #007020">preg_replace</span>(<span style="color: #4070a0">&#39;/(.*)/e&#39;</span>, <span style="color: #666666">@</span><span style="color: #bb60d5">$_POST</span>[<span style="color: #4070a0">&#39;abcdef&#39;</span>], <span style="color: #4070a0">&#39;&#39;</span>);
</pre></div>

<p>Here is an example of result by this tool (you should add a &ndash;minscore option, 10 seems to be a good value):</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span>{
        <span style="color: #062873; font-weight: bold">&quot;score&quot;</span>: <span style="color: #40a070">15</span>,
        <span style="color: #062873; font-weight: bold">&quot;filename&quot;</span>: <span style="color: #4070a0">&quot;/home/etienne/perso/fun/new-caffe/./public/wp-includes/images/crystal/epsg8vpeff.php&quot;</span>,
        <span style="color: #062873; font-weight: bold">&quot;cleanup&quot;</span>: <span style="color: #007020; font-weight: bold">false</span>,
        <span style="color: #062873; font-weight: bold">&quot;details&quot;</span>: [
            {
                <span style="color: #062873; font-weight: bold">&quot;score&quot;</span>: <span style="color: #40a070">5</span>,
                <span style="color: #062873; font-weight: bold">&quot;details&quot;</span>: <span style="color: #4070a0">&quot;&quot;</span>,
                <span style="color: #062873; font-weight: bold">&quot;rule&quot;</span>: <span style="color: #4070a0">&quot;UA_GOOGLE&quot;</span>,
                <span style="color: #062873; font-weight: bold">&quot;description&quot;</span>: <span style="color: #4070a0">&quot;V\u00e9rifie le User-Agent contre Google&quot;</span>
            },
            {
                <span style="color: #062873; font-weight: bold">&quot;score&quot;</span>: <span style="color: #40a070">10</span>,
                <span style="color: #062873; font-weight: bold">&quot;details&quot;</span>: <span style="color: #4070a0">&quot;line 1&quot;</span>,
                <span style="color: #062873; font-weight: bold">&quot;rule&quot;</span>: <span style="color: #4070a0">&quot;VERY_LONG_LINE_EARLY&quot;</span>,
                <span style="color: #062873; font-weight: bold">&quot;description&quot;</span>: <span style="color: #4070a0">&quot;Contient une ligne de plus de 3000 caract\u00e8res en d\u00e9but de fichier&quot;</span>
            },
            {
                <span style="color: #062873; font-weight: bold">&quot;score&quot;</span>: <span style="color: #40a070">0</span>,
                <span style="color: #062873; font-weight: bold">&quot;details&quot;</span>: <span style="color: #4070a0">&quot;1 lines&quot;</span>,
                <span style="color: #062873; font-weight: bold">&quot;rule&quot;</span>: <span style="color: #4070a0">&quot;FEW_LINES&quot;</span>,
                <span style="color: #062873; font-weight: bold">&quot;description&quot;</span>: <span style="color: #4070a0">&quot;Contient peu de lignes&quot;</span>
            }
        ],
        <span style="color: #062873; font-weight: bold">&quot;mtime&quot;</span>: <span style="color: #40a070">1463402470.307976</span>,
        <span style="color: #062873; font-weight: bold">&quot;ctime&quot;</span>: <span style="color: #40a070">1463402470.307976</span>
    }
</pre></div>

<h2 id="comparison">Comparison</h2>

<p>I have tested these tools on a wordpress website which has 38 different malicious files (mainly simple backdoors but also mass mailers or other malicious files).</p>

<p><center><img src="/media/doctor1.jpg" alt="Doctor" /></center></p>

<p>Here are the results:</p>

<table>
<thead>
<tr>
<th>Tool</th>
<th align="center">True Positive</th>
<th align="right">False Positive</th>
</tr>
</thead>

<tbody>
<tr>
<td>Linux Malware Detect</td>
<td align="center">4 / 39</td>
<td align="right">0</td>
</tr>

<tr>
<td>ClamAV (default)</td>
<td align="center">4 / 39</td>
<td align="right">0</td>
</tr>

<tr>
<td>php-malware-finder</td>
<td align="center">28 / 39</td>
<td align="right">126</td>
</tr>

<tr>
<td>php-malware-scanner (minscore 10)</td>
<td align="center">10 / 39</td>
<td align="right">0</td>
</tr>
</tbody>
</table>

<p>So nothing is perfect, likely something to do to improve these results.</p>

<p>Hasta Luego!</p>

                
                    
                
                

                


            </div>
        </div>
    </body>
</html>

